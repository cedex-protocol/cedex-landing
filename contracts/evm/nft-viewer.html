<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RoleBasedNFT Collection Viewer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
        }
        h1 {
            color: #333;
            margin-bottom: 20px;
        }
        .wallet-info {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        .info-card {
            background: #f7f7f7;
            padding: 15px 20px;
            border-radius: 10px;
            flex: 1;
            min-width: 200px;
        }
        .info-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 5px;
        }
        .info-value {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            word-break: break-all;
        }
        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: transform 0.2s;
        }
        button:hover {
            transform: translateY(-2px);
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .nft-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .nft-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s;
        }
        .nft-card:hover {
            transform: translateY(-5px);
        }
        .nft-image {
            width: 100%;
            height: 300px;
            object-fit: cover;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 100px;
        }
        .nft-details {
            padding: 20px;
        }
        .nft-name {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .nft-trait {
            background: #f0f0f0;
            padding: 5px 10px;
            border-radius: 5px;
            display: inline-block;
            margin: 5px 5px 5px 0;
            font-size: 14px;
        }
        .mint-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
        }
        .role-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        .role-button {
            flex: 1;
            padding: 15px;
            background: #f7f7f7;
            border: 2px solid transparent;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .role-button:hover {
            border-color: #667eea;
        }
        .role-button.selected {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .role-button.owned {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            display: none;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            display: block;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            display: block;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: white;
            font-size: 18px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸŽ¨ Genesis NFT Collection</h1>
            <div class="wallet-info">
                <div class="info-card">
                    <div class="info-label">Contract Address</div>
                    <div class="info-value" id="contractAddress">0x8d3A702B6a813f2c1C9FAfe24B6f1E925D169D23</div>
                </div>
                <div class="info-card">
                    <div class="info-label">Your Wallet</div>
                    <div class="info-value" id="walletAddress">Not connected</div>
                </div>
                <div class="info-card">
                    <div class="info-label">Your Balance</div>
                    <div class="info-value" id="nftBalance">0 NFTs</div>
                </div>
            </div>
            <div class="controls">
                <button id="connectWallet">Connect Wallet</button>
                <button id="refreshNFTs" style="display: none;">Refresh My NFTs</button>
            </div>
        </div>

        <div class="mint-section" id="mintSection" style="display: none;">
            <h2>Mint Your Role NFT</h2>
            <p style="margin: 10px 0; color: #666;">Choose a role to mint. You can have up to 3 NFTs (one of each role).</p>
            <div class="role-buttons">
                <div class="role-button" data-role="0">
                    <div style="font-size: 40px; margin-bottom: 10px;">ðŸ“Š</div>
                    <div style="font-weight: bold;">TRADER</div>
                    <div style="font-size: 12px; color: #666; margin-top: 5px;">Active market participant</div>
                </div>
                <div class="role-button" data-role="1">
                    <div style="font-size: 40px; margin-bottom: 10px;">ðŸ’§</div>
                    <div style="font-weight: bold;">LIQUIDITY PROVIDER</div>
                    <div style="font-size: 12px; color: #666; margin-top: 5px;">Provides market liquidity</div>
                </div>
                <div class="role-button" data-role="2">
                    <div style="font-size: 40px; margin-bottom: 10px;">ðŸ’Ž</div>
                    <div style="font-weight: bold;">HOLDER</div>
                    <div style="font-size: 12px; color: #666; margin-top: 5px;">Long-term investor</div>
                </div>
            </div>
            <button id="mintButton" style="margin-top: 20px; width: 100%;" disabled>Select a Role to Mint</button>
            <div id="mintStatus" class="status"></div>
        </div>

        <div id="nftContainer">
            <div class="loading">Connect your wallet to view NFTs...</div>
        </div>
    </div>

    <script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js"></script>
    <script>
        const CONTRACT_ADDRESS = '0x8d3A702B6a813f2c1C9FAfe24B6f1E925D169D23';
        const CONTRACT_ABI = [
            "function balanceOf(address owner) view returns (uint256)",
            "function tokenURI(uint256 tokenId) view returns (string)",
            "function mintWithRole(uint8 role) external",
            "function userHasRole(address user, uint8 role) view returns (bool)",
            "function getUserRoles(address user) view returns (bool hasTrader, bool hasLiquidityProvider, bool hasHolder)",
            "function MAX_SUPPLY() view returns (uint256)",
            "function MAX_PER_WALLET() view returns (uint256)",
            "event NFTMinted(address indexed minter, uint256 tokenId, uint8 role)",
            "event Transfer(address indexed from, address indexed to, uint256 indexed tokenId)"
        ];

        let provider, signer, contract, userAddress;
        let selectedRole = null;

        async function connectWallet() {
            if (typeof window.ethereum === 'undefined') {
                alert('Please install MetaMask to use this dApp!');
                return;
            }

            try {
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
                userAddress = await signer.getAddress();

                document.getElementById('walletAddress').textContent = 
                    userAddress.slice(0, 6) + '...' + userAddress.slice(-4);
                document.getElementById('connectWallet').style.display = 'none';
                document.getElementById('refreshNFTs').style.display = 'inline-block';
                document.getElementById('mintSection').style.display = 'block';

                await loadUserNFTs();
                await checkUserRoles();
            } catch (error) {
                console.error('Failed to connect wallet:', error);
                alert('Failed to connect wallet. Please try again.');
            }
        }

        async function checkUserRoles() {
            try {
                const roles = await contract.getUserRoles(userAddress);
                const roleButtons = document.querySelectorAll('.role-button');
                
                roleButtons.forEach((button, index) => {
                    const hasRole = index === 0 ? roles.hasTrader : 
                                   index === 1 ? roles.hasLiquidityProvider : 
                                   roles.hasHolder;
                    
                    if (hasRole) {
                        button.classList.add('owned');
                        button.innerHTML += '<div style="color: green; font-size: 12px; margin-top: 5px;">âœ“ Already Owned</div>';
                    }
                });
            } catch (error) {
                console.error('Failed to check user roles:', error);
            }
        }

        async function loadUserNFTs() {
            const container = document.getElementById('nftContainer');
            container.innerHTML = '<div class="loading">Loading your NFTs...</div>';

            try {
                const balance = await contract.balanceOf(userAddress);
                document.getElementById('nftBalance').textContent = `${balance} NFTs`;

                if (balance.eq(0)) {
                    container.innerHTML = '<div class="loading">You don\'t own any NFTs yet. Mint one above!</div>';
                    return;
                }

                // Listen for Transfer events to find user's tokens
                const filter = contract.filters.Transfer(null, userAddress);
                const events = await contract.queryFilter(filter);
                
                const nftHTML = [];
                const roleEmojis = {'0': 'ðŸ“Š', '1': 'ðŸ’§', '2': 'ðŸ’Ž'};
                const roleNames = ['Trader', 'Liquidity Provider', 'Holder'];

                for (const event of events) {
                    const tokenId = event.args.tokenId.toString();
                    try {
                        const tokenURI = await contract.tokenURI(tokenId);
                        const metadata = JSON.parse(atob(tokenURI.split(',')[1]));
                        
                        const roleValue = metadata.attributes.find(a => a.trait_type === 'Role')?.value || 'Unknown';
                        const roleIndex = roleNames.indexOf(roleValue);
                        const emoji = roleEmojis[roleIndex] || 'ðŸŽ¨';
                        
                        nftHTML.push(`
                            <div class="nft-card">
                                <div class="nft-image">${emoji}</div>
                                <div class="nft-details">
                                    <div class="nft-name">${metadata.name}</div>
                                    <div class="nft-trait">Role: ${roleValue}</div>
                                    <div class="nft-trait">Token ID: #${tokenId}</div>
                                </div>
                            </div>
                        `);
                    } catch (error) {
                        console.error(`Failed to load NFT #${tokenId}:`, error);
                    }
                }

                container.innerHTML = '<div class="nft-grid">' + nftHTML.join('') + '</div>';
            } catch (error) {
                console.error('Failed to load NFTs:', error);
                container.innerHTML = '<div class="loading">Failed to load NFTs. Please try again.</div>';
            }
        }

        async function mintNFT() {
            if (selectedRole === null) {
                alert('Please select a role first!');
                return;
            }

            const statusDiv = document.getElementById('mintStatus');
            statusDiv.className = 'status';
            statusDiv.style.display = 'none';

            try {
                const mintButton = document.getElementById('mintButton');
                mintButton.disabled = true;
                mintButton.textContent = 'Minting...';

                const tx = await contract.mintWithRole(selectedRole);
                statusDiv.className = 'status success';
                statusDiv.textContent = `Transaction submitted! Hash: ${tx.hash}`;
                statusDiv.style.display = 'block';

                await tx.wait();
                statusDiv.textContent = 'âœ… NFT minted successfully!';
                
                setTimeout(() => {
                    loadUserNFTs();
                    checkUserRoles();
                    statusDiv.style.display = 'none';
                    selectedRole = null;
                    document.querySelectorAll('.role-button').forEach(b => b.classList.remove('selected'));
                    mintButton.textContent = 'Select a Role to Mint';
                }, 3000);
            } catch (error) {
                console.error('Minting failed:', error);
                statusDiv.className = 'status error';
                statusDiv.textContent = `âŒ Minting failed: ${error.message}`;
                statusDiv.style.display = 'block';
            } finally {
                document.getElementById('mintButton').disabled = false;
                if (selectedRole !== null) {
                    document.getElementById('mintButton').textContent = 'Mint NFT';
                }
            }
        }

        // Event listeners
        document.getElementById('connectWallet').addEventListener('click', connectWallet);
        document.getElementById('refreshNFTs').addEventListener('click', loadUserNFTs);
        document.getElementById('mintButton').addEventListener('click', mintNFT);

        document.querySelectorAll('.role-button').forEach(button => {
            button.addEventListener('click', function() {
                if (this.classList.contains('owned')) {
                    alert('You already own this role!');
                    return;
                }
                
                document.querySelectorAll('.role-button').forEach(b => b.classList.remove('selected'));
                this.classList.add('selected');
                selectedRole = parseInt(this.dataset.role);
                document.getElementById('mintButton').disabled = false;
                document.getElementById('mintButton').textContent = 'Mint NFT';
            });
        });

        // Auto-connect if wallet was previously connected
        if (window.ethereum && window.ethereum.selectedAddress) {
            connectWallet();
        }
    </script>
</body>
</html>